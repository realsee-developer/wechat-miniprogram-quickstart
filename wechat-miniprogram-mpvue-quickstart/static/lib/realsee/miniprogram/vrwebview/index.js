function e(e,t,r,i){return new(r||(r=Promise))((function(s,n){function o(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))}function t(e){const t={};if(0===e.length)return{};for(const r of e.split("&")){const[e,i]=r.split("=");t[e]=Object.prototype.hasOwnProperty.call(t,e)?[].concat(t[e],decodeURIComponent(i)):decodeURIComponent(i)}return t}function r(e,r){const i="string"==typeof r?t(r):r,[s,n=""]=e.split("#"),[o,a=""]=s.split("?"),c=t(a),u=function(e){const t=[];for(const r in e){const i=e[r],s=Array.isArray(i)?i.reduce(((e,t)=>`${r}=${encodeURIComponent(e)}&${r}=${encodeURIComponent(t)}`)):`${r}=${encodeURIComponent(i)}`;t.push(s)}return t.join("&")}(Object.assign({},c,i));return`${o}${u.length?`?${u}`:""}${n?`#${n}`:""}`}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var i,s,n={},o={},a={get exports(){return o},set exports(e){o=e}};function c(){return i||(i=1,a.exports=(e=e||function(e,t){var r={},i=r.lib={},s=i.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var r=new e;return t&&r.mixIn(t),r.hasOwnProperty("init")||(r.init=function(){r.$super.init.apply(this,arguments)}),r.init.prototype=r,r.$super=this,r},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),n=i.WordArray=s.extend({init:function(e,r){e=this.words=e||[],this.sigBytes=r!=t?r:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,r=e.words,i=this.sigBytes,s=e.sigBytes;if(this.clamp(),i%4)for(var n=0;n<s;n++){var o=r[n>>>2]>>>24-n%4*8&255;t[i+n>>>2]|=o<<24-(i+n)%4*8}else if(r.length>65535)for(n=0;n<s;n+=4)t[i+n>>>2]=r[n>>>2];else t.push.apply(t,r);return this.sigBytes+=s,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r,i=[],s=function(t){var r=987654321,i=4294967295;return function(){var s=((r=36969*(65535&r)+(r>>16)&i)<<16)+(t=18e3*(65535&t)+(t>>16)&i)&i;return s/=4294967296,(s+=.5)*(e.random()>.5?1:-1)}},o=0;o<t;o+=4){var a=s(4294967296*(r||e.random()));r=987654071*a(),i.push(4294967296*a()|0)}return new n.init(i,t)}}),o=r.enc={},a=o.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],s=0;s<r;s++){var n=t[s>>>2]>>>24-s%4*8&255;i.push((n>>>4).toString(16)),i.push((15&n).toString(16))}return i.join("")},parse:function(e){for(var t=e.length,r=[],i=0;i<t;i+=2)r[i>>>3]|=parseInt(e.substr(i,2),16)<<24-i%8*4;return new n.init(r,t/2)}},c=o.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],s=0;s<r;s++){var n=t[s>>>2]>>>24-s%4*8&255;i.push(String.fromCharCode(n))}return i.join("")},parse:function(e){for(var t=e.length,r=[],i=0;i<t;i++)r[i>>>2]|=(255&e.charCodeAt(i))<<24-i%4*8;return new n.init(r,t)}},u=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},l=i.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new n.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=u.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r=this._data,i=r.words,s=r.sigBytes,o=this.blockSize,a=s/(4*o),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*o,u=e.min(4*c,s);if(c){for(var l=0;l<c;l+=o)this._doProcessBlock(i,l);var h=i.splice(0,c);r.sigBytes-=u}return new n.init(h,u)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});i.Hasher=l.extend({cfg:s.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new h.HMAC.init(e,r).finalize(t)}}});var h=r.algo={};return r}(Math),e)),o;var e}({get exports(){return n},set exports(e){n=e}}).exports=(s=c(),function(e){var t=s,r=t.lib,i=r.WordArray,n=r.Hasher,o=t.algo,a=[];!function(){for(var t=0;t<64;t++)a[t]=4294967296*e.abs(e.sin(t+1))|0}();var c=o.MD5=n.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var i=t+r,s=e[i];e[i]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8)}var n=this._hash.words,o=e[t+0],c=e[t+1],d=e[t+2],v=e[t+3],f=e[t+4],m=e[t+5],b=e[t+6],g=e[t+7],_=e[t+8],y=e[t+9],w=e[t+10],E=e[t+11],k=e[t+12],S=e[t+13],O=e[t+14],I=e[t+15],A=n[0],P=n[1],T=n[2],C=n[3];A=u(A,P,T,C,o,7,a[0]),C=u(C,A,P,T,c,12,a[1]),T=u(T,C,A,P,d,17,a[2]),P=u(P,T,C,A,v,22,a[3]),A=u(A,P,T,C,f,7,a[4]),C=u(C,A,P,T,m,12,a[5]),T=u(T,C,A,P,b,17,a[6]),P=u(P,T,C,A,g,22,a[7]),A=u(A,P,T,C,_,7,a[8]),C=u(C,A,P,T,y,12,a[9]),T=u(T,C,A,P,w,17,a[10]),P=u(P,T,C,A,E,22,a[11]),A=u(A,P,T,C,k,7,a[12]),C=u(C,A,P,T,S,12,a[13]),T=u(T,C,A,P,O,17,a[14]),A=l(A,P=u(P,T,C,A,I,22,a[15]),T,C,c,5,a[16]),C=l(C,A,P,T,b,9,a[17]),T=l(T,C,A,P,E,14,a[18]),P=l(P,T,C,A,o,20,a[19]),A=l(A,P,T,C,m,5,a[20]),C=l(C,A,P,T,w,9,a[21]),T=l(T,C,A,P,I,14,a[22]),P=l(P,T,C,A,f,20,a[23]),A=l(A,P,T,C,y,5,a[24]),C=l(C,A,P,T,O,9,a[25]),T=l(T,C,A,P,v,14,a[26]),P=l(P,T,C,A,_,20,a[27]),A=l(A,P,T,C,S,5,a[28]),C=l(C,A,P,T,d,9,a[29]),T=l(T,C,A,P,g,14,a[30]),A=h(A,P=l(P,T,C,A,k,20,a[31]),T,C,m,4,a[32]),C=h(C,A,P,T,_,11,a[33]),T=h(T,C,A,P,E,16,a[34]),P=h(P,T,C,A,O,23,a[35]),A=h(A,P,T,C,c,4,a[36]),C=h(C,A,P,T,f,11,a[37]),T=h(T,C,A,P,g,16,a[38]),P=h(P,T,C,A,w,23,a[39]),A=h(A,P,T,C,S,4,a[40]),C=h(C,A,P,T,o,11,a[41]),T=h(T,C,A,P,v,16,a[42]),P=h(P,T,C,A,b,23,a[43]),A=h(A,P,T,C,y,4,a[44]),C=h(C,A,P,T,k,11,a[45]),T=h(T,C,A,P,I,16,a[46]),A=p(A,P=h(P,T,C,A,d,23,a[47]),T,C,o,6,a[48]),C=p(C,A,P,T,g,10,a[49]),T=p(T,C,A,P,O,15,a[50]),P=p(P,T,C,A,m,21,a[51]),A=p(A,P,T,C,k,6,a[52]),C=p(C,A,P,T,v,10,a[53]),T=p(T,C,A,P,w,15,a[54]),P=p(P,T,C,A,c,21,a[55]),A=p(A,P,T,C,_,6,a[56]),C=p(C,A,P,T,I,10,a[57]),T=p(T,C,A,P,b,15,a[58]),P=p(P,T,C,A,S,21,a[59]),A=p(A,P,T,C,f,6,a[60]),C=p(C,A,P,T,E,10,a[61]),T=p(T,C,A,P,d,15,a[62]),P=p(P,T,C,A,y,21,a[63]),n[0]=n[0]+A|0,n[1]=n[1]+P|0,n[2]=n[2]+T|0,n[3]=n[3]+C|0},_doFinalize:function(){var t=this._data,r=t.words,i=8*this._nDataBytes,s=8*t.sigBytes;r[s>>>5]|=128<<24-s%32;var n=e.floor(i/4294967296),o=i;r[15+(s+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),r[14+(s+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t.sigBytes=4*(r.length+1),this._process();for(var a=this._hash,c=a.words,u=0;u<4;u++){var l=c[u];c[u]=16711935&(l<<8|l>>>24)|4278255360&(l<<24|l>>>8)}return a},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});function u(e,t,r,i,s,n,o){var a=e+(t&r|~t&i)+s+o;return(a<<n|a>>>32-n)+t}function l(e,t,r,i,s,n,o){var a=e+(t&i|r&~i)+s+o;return(a<<n|a>>>32-n)+t}function h(e,t,r,i,s,n,o){var a=e+(t^r^i)+s+o;return(a<<n|a>>>32-n)+t}function p(e,t,r,i,s,n,o){var a=e+(r^(t|~i))+s+o;return(a<<n|a>>>32-n)+t}t.MD5=n._createHelper(c),t.HmacMD5=n._createHmacHelper(c)}(Math),s.MD5);var u=n;const l=({ts:e,ak:t,sk:r,uuid:i,member:s})=>u(`${e}_${t}_${r}_${i}_${s}`).toString().toUpperCase();function h(e){const{ak:t,sk:r,origin:i,members:s,endpoint:n,tpl:o,qs:a}=e,c=`${Date.now()}`,u="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),h=l({ts:c,ak:t,sk:r,uuid:u,member:s.weapp}),p=((e,t)=>{const r=Object.keys(t).reduce(((e,r)=>e.replace(`{{${r}}}`,`${t[r]}`)),e);return encodeURI(r)})(o,{origin:i,endpoint:n,uuid:u,member:s.weapp,ak:t,ts:c,sign:h}),d=((e,t)=>Object.keys(t).reduce(((e,r)=>e.replace(`{{${r}}}`,`${t[r]}`)),e))(a,{uuid:u,ts:c,sign:l({ts:c,ak:t,sk:r,uuid:u,member:s.web})});return{wssUrl4Weapp:p,wssQuery4Webview:d}}const p=(d="$$REALSEE_MINIPROGRAM_LIBRARY_EVENT$$","undefined"==typeof Symbol?`$Symbol<${d}>$`:Symbol(d));var d;function v(e){return e[p]||(e[p]={}),e[p]}class f{hasListener(e){const t=v(this);return t&&t[e]&&t[e].length>0}on(e,t,r){const i=v(this);return i[e]||(i[e]=[]),i[e].push([t,r||!1]),()=>this.off(e,t)}once(e,t){return this.on(e,t,!0)}off(e,t){if(void 0===e)return void((r=this)[p]||delete r[p]);var r;const i=v(this);if(i[e]||(i[e]=[]),void 0===t)return void(i[e].length=0);let s=0;for(;s<i[e].length&&i[e][s][0]!==t;s++);s<i[e].length&&i[e].splice(s,1)}emit(e,...t){let r=!1;const i=v(this)[e]||[];for(const s of i.slice()){const[i,n=!1]=s,o=i(...t);n&&this.off(e,i),!1===o&&(r=!0)}return r}}const m=()=>(65536*(1+Math.random())|0).toString(16).substring(1);var b;!function(e){e[e.NOTINITIALIZED=-1]="NOTINITIALIZED",e[e.OPEN=1]="OPEN",e[e.CONNECTING=0]="CONNECTING",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(b||(b={}));const g={NOTINITIALIZED:-1,OPEN:1,CONNECTING:0,CLOSING:2,CLOSED:3};class _ extends f{get readyState(){return this._readyState}constructor(e){super(),Object.defineProperty(this,"_readyState",{enumerable:!0,configurable:!0,writable:!0,value:b.NOTINITIALIZED}),Object.defineProperty(this,"_socketTask",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=wx.connectSocket(e);this._socketTask=Object.assign(Object.assign({id:(m()+m()+"-"+m()+"-4"+m().substr(0,3)+"-"+m()+"-"+m()+m()+m()).toLowerCase()},g),t),this._registarLifeEvent(this._socketTask),this._registarRawEvent(this._socketTask)}_registarLifeEvent(e){e.onOpen((()=>e.id===this._socketTask.id?this._readyState=b.OPEN:void 0)),e.onClose((()=>e.id===this._socketTask.id?this._readyState=b.CLOSED:void 0)),e.onError((()=>e.id===this._socketTask.id?this._readyState=b.CLOSED:void 0))}_registarRawEvent(e){e.onOpen((t=>e.id===this._socketTask.id?this.emit("open",t):void 0));e.onClose((t=>e.id===this._socketTask.id?this.emit("close",t):void 0));e.onMessage((t=>e.id===this._socketTask.id?this.emit("message",t):void 0));e.onError((t=>e.id===this._socketTask.id?this.emit("error",t):void 0))}close(e,t){this._readyState=b.CLOSING,this._socketTask.close({code:e,reason:t})}send(e){this._socketTask.send({data:e})}addEventListener(e,t,r){r?this.once(e,t):this.on(e,t)}removeEventListener(e,t){this.off(e,t)}}Object.defineProperty(_,"NOTINITIALIZED",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(_,"CONNECTING",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(_,"OPEN",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(_,"CLOSING",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(_,"CLOSED",{enumerable:!0,configurable:!0,writable:!0,value:3});class y extends f{get attempts(){return this._attempts}constructor(t){super(),Object.defineProperty(this,"_realWebSocket",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_url",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_protocols",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_readyState",{enumerable:!0,configurable:!0,writable:!0,value:b.NOTINITIALIZED}),Object.defineProperty(this,"_options",{enumerable:!0,configurable:!0,writable:!0,value:{timeout:3e4,shouldReconnect:(e,t)=>{if(1008!==e.code&&1011!==e.code)return[0,3e3,1e4][t.attempts]},should1000Reconnect:!1,ignoreConnectivityEvents:!1,automaticOpen:!1}}),Object.defineProperty(this,"_connectTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_attempts",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_reconnects",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"_reconnectWhenOnlineAgain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_explicitlyClosed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_pendingReconnect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_connectivityEventsAttached",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_heathCheckTimer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_healthCheck",{enumerable:!0,configurable:!0,writable:!0,value:()=>e(this,void 0,void 0,(function*(){this._realWebSocket&&this._realWebSocket.readyState!==this._readyState&&(this._readyState=this._realWebSocket.readyState,this._readyState===b.CLOSING&&this.emit("closing")),this._heathCheckTimer=setTimeout((()=>this._healthCheck()),2e3)}))}),Object.defineProperty(this,"_clearHeathCheckIfNeed",{enumerable:!0,configurable:!0,writable:!0,value:()=>{this._heathCheckTimer&&(clearTimeout(this._heathCheckTimer),this._heathCheckTimer=void 0)}}),Object.defineProperty(this,"_startHealthCheck",{enumerable:!0,configurable:!0,writable:!0,value:()=>{this._clearHeathCheckIfNeed(),this._heathCheckTimer=setTimeout((()=>this._healthCheck()))}}),Object.defineProperty(this,"_stopHealthCheck",{enumerable:!0,configurable:!0,writable:!0,value:()=>{this._clearHeathCheckIfNeed()}}),Object.defineProperty(this,"_clearPendingReconnectIfNeeded",{enumerable:!0,configurable:!0,writable:!0,value:()=>{this._pendingReconnect&&(clearTimeout(this._pendingReconnect),this._pendingReconnect=void 0)}}),Object.defineProperty(this,"_online",{enumerable:!0,configurable:!0,writable:!0,value:e=>{this._reconnectWhenOnlineAgain&&(this._clearPendingReconnectIfNeeded(),this._reconnect(e))}}),Object.defineProperty(this,"_offline",{enumerable:!0,configurable:!0,writable:!0,value:()=>{var e;this._reconnectWhenOnlineAgain=!0,null===(e=this._realWebSocket)||void 0===e||e.close(1e3,"offline")}}),Object.defineProperty(this,"_networkChangeHandler",{enumerable:!0,configurable:!0,writable:!0,value:e=>{e.isConnected?this._online({code:1e3,reason:"online"}):this._offline()}}),Object.defineProperty(this,"_detachConnectivityEvents",{enumerable:!0,configurable:!0,writable:!0,value:()=>{this._connectivityEventsAttached&&(wx.offNetworkStatusChange(this._networkChangeHandler),this._connectivityEventsAttached=!1)}}),Object.defineProperty(this,"_attachConnectivityEvents",{enumerable:!0,configurable:!0,writable:!0,value:()=>{this._connectivityEventsAttached||(wx.onNetworkStatusChange(this._networkChangeHandler),this._connectivityEventsAttached=!0)}}),Object.defineProperty(this,"send",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t,r;(null===(t=this._realWebSocket)||void 0===t?void 0:t.readyState)===_.OPEN&&(null===(r=this._realWebSocket)||void 0===r||r.send(e))}}),Object.defineProperty(this,"close",{enumerable:!0,configurable:!0,writable:!0,value:(e,t)=>{var r;return"number"!=typeof e&&(t=e,e=1e3),this._clearPendingReconnectIfNeeded(),this._reconnectWhenOnlineAgain=!1,this._explicitlyClosed=!0,this._detachConnectivityEvents(),null===(r=this._realWebSocket)||void 0===r?void 0:r.close(e,t)}}),Object.defineProperty(this,"open",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t,r;e&&(this._url=e),(null===(t=this._realWebSocket)||void 0===t?void 0:t.readyState)!==_.OPEN&&(null===(r=this._realWebSocket)||void 0===r?void 0:r.readyState)!==_.CONNECTING&&(this._clearPendingReconnectIfNeeded(),this._reconnectWhenOnlineAgain=!1,this._explicitlyClosed=!1,this._createWebSocket())}}),Object.defineProperty(this,"_createWebSocket",{enumerable:!0,configurable:!0,writable:!0,value:()=>{var e,t,r;const i="string"==typeof this._url?this._url:null===(e=this._url)||void 0===e?void 0:e.call(this,this);if(!i)return;this._pendingReconnect=void 0,this._removeWebSocketEvent();const s={url:i,protocols:this._protocols||void 0,timeout:this._options.timeout};this._realWebSocket=new _(s),this._attempts=this._attempts+1,this.emit("connecting",{detail:{attempts:this._attempts,reconnects:this._reconnects}});this._connectTimeout=setTimeout((()=>{this._connectTimeout=void 0,this._detachConnectivityEvents(),this.emit("timeout",{detail:{attempts:this._attempts,reconnects:this._reconnects}})}),null===(t=this._options)||void 0===t?void 0:t.timeout),this._dispatchWebSocketEvent(),(null===(r=this._options)||void 0===r?void 0:r.ignoreConnectivityEvents)||this._attachConnectivityEvents()}}),Object.defineProperty(this,"_removeWebSocketEvent",{enumerable:!0,configurable:!0,writable:!0,value:()=>{var e,t,r,i;null===(e=this._realWebSocket)||void 0===e||e.removeEventListener("open",this._webSocketOpenHandler),null===(t=this._realWebSocket)||void 0===t||t.removeEventListener("close",this._webSocketCloseHandler),null===(r=this._realWebSocket)||void 0===r||r.removeEventListener("error",this._webSocketErrorHandler),null===(i=this._realWebSocket)||void 0===i||i.removeEventListener("message",this._webSocketMessageHandler)}}),Object.defineProperty(this,"_dispatchWebSocketEvent",{enumerable:!0,configurable:!0,writable:!0,value:()=>{var e,t,r,i;null===(e=this._realWebSocket)||void 0===e||e.addEventListener("open",this._webSocketOpenHandler),null===(t=this._realWebSocket)||void 0===t||t.addEventListener("close",this._webSocketCloseHandler),null===(r=this._realWebSocket)||void 0===r||r.addEventListener("error",this._webSocketErrorHandler),null===(i=this._realWebSocket)||void 0===i||i.addEventListener("message",this._webSocketMessageHandler)}}),Object.defineProperty(this,"_webSocketOpenHandler",{enumerable:!0,configurable:!0,writable:!0,value:e=>{this._connectTimeout&&(clearTimeout(this._connectTimeout),this._connectTimeout=void 0);const t=++this._reconnects,r=this._attempts;return this._attempts=0,this._reconnectWhenOnlineAgain=!1,this._startHealthCheck(),this.emit("open",Object.assign(e,{detail:{reconnects:t,attempts:r}}))}}),Object.defineProperty(this,"_webSocketCloseHandler",{enumerable:!0,configurable:!0,writable:!0,value:e=>(this._reconnect(e),this._stopHealthCheck(),this.emit("close",e))}),Object.defineProperty(this,"_webSocketErrorHandler",{enumerable:!0,configurable:!0,writable:!0,value:e=>this.emit("error",{detail:{error:e.errMsg}})}),Object.defineProperty(this,"_webSocketMessageHandler",{enumerable:!0,configurable:!0,writable:!0,value:e=>this.emit("message",{detail:{data:e.data}})}),t&&this.setOptions(t),this._startHealthCheck()}setOptions(e){if(!e)return;this._url=e.url,this._protocols=e.protocols;const t=Object.assign(this._options,e.robustOptions||{});if("number"!=typeof(null==t?void 0:t.timeout))throw new Error("timeout must be the number of milliseconds to timeout a connection attempt");if("function"!=typeof(null==t?void 0:t.shouldReconnect))throw new Error("shouldReconnect must be a function that returns the number of milliseconds to wait for a reconnect attempt, or null or undefined to not reconnect.");this._options=t,this._options.automaticOpen&&this._createWebSocket()}_reconnect(t){var r,i,s;return e(this,void 0,void 0,(function*(){if(!(null===(r=this._options)||void 0===r?void 0:r.should1000Reconnect)&&1e3===t.code||this._explicitlyClosed)return void(this._attempts=0);if(!(yield new Promise((e=>wx.getNetworkType({complete:t=>"none"!==t.networkType?e(!0):e(!1)})))))return void(this._reconnectWhenOnlineAgain=!0);const e=null===(s=null===(i=this._options)||void 0===i?void 0:i.shouldReconnect)||void 0===s?void 0:s.call(i,t,this);"number"==typeof e&&(this._pendingReconnect=setTimeout(this._createWebSocket,e))}))}}var w={},E={get exports(){return w},set exports(e){w=e}};!function(){var e=[],t=3988292384;function r(e){var r,i,s,n,o=-1;for(r=0,s=e.length;r<s;r+=1){for(n=255&(o^e[r]),i=0;i<8;i+=1)1==(1&n)?n=n>>>1^t:n>>>=1;o=o>>>8^n}return-1^o}function i(t,r){var s,n,o;if(void 0!==i.crc&&r&&t||(i.crc=-1,t)){for(s=i.crc,n=0,o=t.length;n<o;n+=1)s=s>>>8^e[255&(s^t[n])];return i.crc=s,-1^s}}!function(){var r,i,s;for(i=0;i<256;i+=1){for(r=i,s=0;s<8;s+=1)1&r?r=t^r>>>1:r>>>=1;e[i]=r>>>0}}(),E.exports=function(e,t){var s;e="string"==typeof e?(s=e,Array.prototype.map.call(s,(function(e){return e.charCodeAt(0)}))):e;return((t?r(e):i(e))>>>0).toString(16)},w.direct=r,w.table=i}();var k,S={},O={},I={get exports(){return O},set exports(e){O=e}};function A(){return k||(k=1,I.exports=function(e){return function(t){var r=e,i=r.lib,s=i.WordArray,n=i.Hasher,o=r.algo,a=[],c=[];!function(){function e(e){for(var r=t.sqrt(e),i=2;i<=r;i++)if(!(e%i))return!1;return!0}function r(e){return 4294967296*(e-(0|e))|0}for(var i=2,s=0;s<64;)e(i)&&(s<8&&(a[s]=r(t.pow(i,.5))),c[s]=r(t.pow(i,1/3)),s++),i++}();var u=[],l=o.SHA256=n.extend({_doReset:function(){this._hash=new s.init(a.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,i=r[0],s=r[1],n=r[2],o=r[3],a=r[4],l=r[5],h=r[6],p=r[7],d=0;d<64;d++){if(d<16)u[d]=0|e[t+d];else{var v=u[d-15],f=(v<<25|v>>>7)^(v<<14|v>>>18)^v>>>3,m=u[d-2],b=(m<<15|m>>>17)^(m<<13|m>>>19)^m>>>10;u[d]=f+u[d-7]+b+u[d-16]}var g=i&s^i&n^s&n,_=(i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22),y=p+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&l^~a&h)+c[d]+u[d];p=h,h=l,l=a,a=o+y|0,o=n,n=s,s=i,i=y+(_+g)|0}r[0]=r[0]+i|0,r[1]=r[1]+s|0,r[2]=r[2]+n|0,r[3]=r[3]+o|0,r[4]=r[4]+a|0,r[5]=r[5]+l|0,r[6]=r[6]+h|0,r[7]=r[7]+p|0},_doFinalize:function(){var e=this._data,r=e.words,i=8*this._nDataBytes,s=8*e.sigBytes;return r[s>>>5]|=128<<24-s%32,r[14+(s+64>>>9<<4)]=t.floor(i/4294967296),r[15+(s+64>>>9<<4)]=i,e.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});r.SHA256=n._createHelper(l),r.HmacSHA256=n._createHmacHelper(l)}(Math),e.SHA256}(c())),O}var P,T={},C={get exports(){return T},set exports(e){T=e}};({get exports(){return S},set exports(e){S=e}}).exports=function(e){return e.HmacSHA256}(c(),A(),P||(P=1,C.exports=function(e){!function(){var t=e,r=t.lib.Base,i=t.enc.Utf8;t.algo.HMAC=r.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=i.parse(t));var r=e.blockSize,s=4*r;t.sigBytes>s&&(t=e.finalize(t)),t.clamp();for(var n=this._oKey=t.clone(),o=this._iKey=t.clone(),a=n.words,c=o.words,u=0;u<r;u++)a[u]^=1549556828,c[u]^=909522486;n.sigBytes=o.sigBytes=s,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})}()}(c())));var L=S,D={};({get exports(){return D},set exports(e){D=e}}).exports=function(e){return r=(t=e).lib.WordArray,t.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,i=this._map;e.clamp();for(var s=[],n=0;n<r;n+=3)for(var o=(t[n>>>2]>>>24-n%4*8&255)<<16|(t[n+1>>>2]>>>24-(n+1)%4*8&255)<<8|t[n+2>>>2]>>>24-(n+2)%4*8&255,a=0;a<4&&n+.75*a<r;a++)s.push(i.charAt(o>>>6*(3-a)&63));var c=i.charAt(64);if(c)for(;s.length%4;)s.push(c);return s.join("")},parse:function(e){var t=e.length,i=this._map,s=i.charAt(64);if(s){var n=e.indexOf(s);-1!=n&&(t=n)}for(var o=[],a=0,c=0;c<t;c++)if(c%4){var u=i.indexOf(e.charAt(c-1))<<c%4*2,l=i.indexOf(e.charAt(c))>>>6-c%4*2;o[a>>>2]|=(u|l)<<24-a%4*8,a++}return r.create(o,a)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},e.enc.Base64;var t,r}(c());var x=D,M={};({get exports(){return M},set exports(e){M=e}}).exports=function(e){return e.enc.Utf8}(c());var R=M;function j(e){const{timestamp:t,appKey:r,appSecret:i,uri:s,method:n,data:o}=e,a=function(e){const{timestamp:t,uri:r,method:i,data:s,appKey:n,appSecret:o}=e,a={method:i.toUpperCase(),url:r,body_crc32:0};if(s){const e=Object.keys(s).sort().map((e=>`${e}=${encodeURIComponent("object"==typeof s[e]?JSON.stringify(s[e]):s[e])}`)).join("&");a.body_crc32=Number("0x"+w(e))}const c=Object.keys(a).sort().map((e=>`${e}=${a[e]}`)).join(""),l=u(`${n}${o}${t}`).toString().toUpperCase();return L(c,l).toString().toUpperCase()}({timestamp:t,appKey:r,appSecret:i,uri:s,method:n,data:o}),c=`${r}:${a}:${t}`;return x.stringify(R.parse(c))}class U extends f{constructor(t,r){super(),Object.defineProperty(this,"_trtc",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_app",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_trtcOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ready",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"oldInitialize",{enumerable:!0,configurable:!0,writable:!0,value:(t,r={})=>e(this,void 0,void 0,(function*(){return this._trtcOptions={sdkAppID:Number(t.config.app_id),userID:t.user_id,userSig:t.user_sig,roomID:Number(t.voiceId)},this._trtc.createPusher(r).pusherAttributes}))}),Object.defineProperty(this,"initializeV2",{enumerable:!0,configurable:!0,writable:!0,value:(t,r={})=>e(this,void 0,void 0,(function*(){return this._trtcOptions={sdkAppID:Number(t.sdkAppID),userID:t.userID,userSig:t.userSig,roomID:t.roomID},this._trtc.createPusher(r).pusherAttributes}))}),this._app=t,this._trtc=r.trtc,this._registerRtcEventHandler()}initialize(t){return e(this,void 0,void 0,(function*(){const{roomID:e,userID:r,rtcConfig:i={}}=t,s={voice_id:e,user_id:r},n=j({timestamp:Number((Date.now()/1e3).toFixed(0)),appKey:this._app.key,appSecret:this._app.secret,uri:this._app.sign,method:"GET",data:s}),o=yield this._initOptions(s,n);return this._trtcOptions={sdkAppID:Number(o.config.app_id),userID:o.user_id,userSig:o.user_sig,roomID:e},this._trtc.createPusher(i).pusherAttributes||{}}))}_initOptions(t,r){return e(this,void 0,void 0,(function*(){return new Promise(((i,s)=>{if(!this._app.sign)throw new Error("app配置项`sign`不得为空");wx.request({url:`${this._app.gateway}${this._app.sign}`,data:t,header:{"x-request-appid":this._app.key,Authorization:r},success:t=>e(this,void 0,void 0,(function*(){if(!t.data)return s("");try{const e=t.data.data;i(e)}catch(e){s(e)}})),fail:e=>s(e)})}))}))}start(){var e,t;null===(t=null===(e=this._trtc.getPusherInstance())||void 0===e?void 0:e.start)||void 0===t||t.call(e)}stop(){var e,t;null===(t=null===(e=this._trtc.getPusherInstance())||void 0===e?void 0:e.stop)||void 0===t||t.call(e)}enterRoom(){return e(this,void 0,void 0,(function*(){return this._trtc.enterRoom(this._trtcOptions)}))}exitRoom(){return e(this,void 0,void 0,(function*(){return this._trtc.getPusherInstance()?this._trtc.exitRoom():{pusher:{},playerList:[]}}))}toggleMicrophone(t){var r;return e(this,void 0,void 0,(function*(){return null===(r=this._trtc)||void 0===r?void 0:r.setPusherAttributes({enableMic:t})}))}getPlayerList(){return e(this,void 0,void 0,(function*(){return yield this._trtc.getPlayerList()}))}_registerRtcEventHandler(){Object.keys(this._trtc.EVENT).forEach((e=>this._trtc.on(e,(t=>this.emit(e,t)))))}pusherStateChangeHandler(e){var t;null===(t=this._trtc)||void 0===t||t.pusherEventHandler(e)}pusherNetStatusHandler(e){var t;null===(t=this._trtc)||void 0===t||t.pusherNetStatusHandler(e)}pusherErrorHandler(e){var t;null===(t=this._trtc)||void 0===t||t.pusherErrorHandler(e)}pusherBGMStartHandler(e){var t;null===(t=this._trtc)||void 0===t||t.pusherBGMStartHandler(e)}pusherBGMProgressHandler(e){var t;null===(t=this._trtc)||void 0===t||t.pusherBGMProgressHandler(e)}pusherBGMCompleteHandler(e){var t;null===(t=this._trtc)||void 0===t||t.pusherBGMCompleteHandler(e)}pusherAudioVolumeNotify(e){var t;null===(t=this._trtc)||void 0===t||t.pusherAudioVolumeNotify(e)}playerStateChange(e){var t;null===(t=this._trtc)||void 0===t||t.playerEventHandler(e)}playerFullscreenChange(e){var t;null===(t=this._trtc)||void 0===t||t.playerFullscreenChange(e)}playerNetStatus(e){var t;null===(t=this._trtc)||void 0===t||t.playerNetStatus(e)}playerAudioVolumeNotify(e){var t;null===(t=this._trtc)||void 0===t||t.playerAudioVolumeNotify(e)}}const B={key:"",secret:"",gateway:"https://app-gateway.realsee.com",startup:"/sdk/open/startup/cold.json",sign:"/sdk/open/live/voice/sign.json"},N={ak:"vr_live_miniapp",endpoint:"proxy",members:{weapp:"miniprogram",web:"webview"},origin:"wss://ws.realsee.com",qs:"wssid={{uuid}}&wstsp={{ts}}&wssig={{sign}}",sk:"153B7156CFEC0E2F805994DC6C9D70F4",tpl:"{{origin}}/{{endpoint}}/{{uuid}}/{{member}}/{{ak}}/{{ts}}/{{sign}}"};class H{constructor(t,r={}){Object.defineProperty(this,"_rtc",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_robustWebSocket",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_appConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_socketParams",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_props",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"init",{enumerable:!0,configurable:!0,writable:!0,value:t=>e(this,void 0,void 0,(function*(){const{options:e}=t,{app:r,rtc:i}=e;this._appConfig=this._getAppConfig(r),this._socketParams=h(this._config),this._robustWebSocket.open(this._socketParams.wssUrl4Weapp),this._initRtc(i.trtc)}))}),Object.defineProperty(this,"_initRtc",{enumerable:!0,configurable:!0,writable:!0,value:e=>{this._rtc=new U(this._appConfig,{trtc:e})}}),Object.defineProperty(this,"dispose",{enumerable:!0,configurable:!0,writable:!0,value:()=>{this._removeWebSocketEvent(),this._robustWebSocket.close(1e3,"退出关闭")}}),Object.defineProperty(this,"_onConnecting",{enumerable:!0,configurable:!0,writable:!0,value:e=>{console.info("realsee jsbridge is connecting",e)}}),Object.defineProperty(this,"_onOpen",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t;console.info("realsee jsbridge is open",e),null===(t=this._props)||void 0===t||t.onReady()}}),Object.defineProperty(this,"_onTimeout",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t;console.info("realsee jsbridge connect timeout",e),null===(t=this._props)||void 0===t||t.onError(new Error("timeout"))}}),Object.defineProperty(this,"_onMessage",{enumerable:!0,configurable:!0,writable:!0,value:t=>e(this,void 0,void 0,(function*(){var e,r,i,s,n;const o=t.detail.data;if("string"==typeof o){const t=this._parseStandardMessage(o);switch(!0){case t.type===G.message&&t.isBuildInMessage:this._handleBuildInMessage(t.rawMessage);break;case t.type===G.message:{const{id:r,data:i}=t.rawMessage;null===(e=this._props)||void 0===e||e.onMessage({id:r,data:i});break}case t.type===G.request:{const{id:e,method:i,args:s}=t.rawMessage;let n=null,o=null;try{o=yield null===(r=this._props)||void 0===r?void 0:r.onRequest(i,s)}catch(e){n=e.message||e}this._postMessage({id:e,method:i,error:n,result:o,command:"response"});break}case t.type===G.scheme:{const{id:e,actionUrl:r,type:s}=t.rawMessage,n=t=>{let r=t instanceof Error?t.message:null,i=t instanceof Error?null:t;this._postMessage({id:e,command:"rsSchemeResponse",result:i,errmsg:r})};null===(i=this._props)||void 0===i||i.onScheme({actionUrl:r,type:s,callback:n});break}default:null===(s=this._props)||void 0===s||s.onError(new Error(`unknown message=(${JSON.stringify(t)})`))}}else null===(n=this._props)||void 0===n||n.onError(new Error("Unsupported message type"))}))}),Object.defineProperty(this,"_onClosing",{enumerable:!0,configurable:!0,writable:!0,value:()=>{console.info("realsee jsbridge is closing")}}),Object.defineProperty(this,"_onClose",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t;null===(t=this._props)||void 0===t||t.onClose(e)}}),Object.defineProperty(this,"_onError",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t;return null===(t=this._props)||void 0===t?void 0:t.onError(new Error(e.detail.error))}}),Object.defineProperty(this,"_parseStandardMessage",{enumerable:!0,configurable:!0,writable:!0,value:e=>{try{const t=JSON.parse(e);switch(!0){case"request"===t.command:return{type:G.request,isOldRequest:!1,isBuildInMessage:!1,rawMessage:t};case"rsSchemeRequest"===t.command:return{type:G.scheme,isOldRequest:!1,isBuildInMessage:!1,rawMessage:t};case"message"===t.command:return{type:G.message,isOldRequest:!1,isBuildInMessage:"string"==typeof t.data&&V.includes(t.data),rawMessage:t};default:return{type:G.request,isOldRequest:!0,isBuildInMessage:!1,rawMessage:t}}}catch(t){const r=e;return{type:G.message,isOldRequest:!0,isBuildInMessage:V.includes(r),rawMessage:r}}}}),Object.defineProperty(this,"_handleBuildInMessage",{enumerable:!0,configurable:!0,writable:!0,value:e=>{switch(e){case W.isReady:return this._postMessage(W.ready);case W.ping:return this._postMessage(W.pong);case W.alive:return this._postMessage(W.alive);case W.pong:return setTimeout((()=>this._postMessage(W.ping)),1e4);case W.ready:return this._postMessage(W.ready);default:return this._postMessage("I don't know what you mean")}}}),Object.defineProperty(this,"_postMessage",{enumerable:!0,configurable:!0,writable:!0,value:e=>{this._robustWebSocket.send(JSON.stringify(e))}}),this._props=t,this._config=Object.assign(N,r),this._robustWebSocket=new y,this._addWebSocketEvent()}get rtc(){return this._rtc}get wssQuery4Webview(){var e;return null===(e=this._socketParams)||void 0===e?void 0:e.wssQuery4Webview}_addWebSocketEvent(){this._robustWebSocket.on("connecting",this._onConnecting),this._robustWebSocket.on("open",this._onOpen),this._robustWebSocket.on("timeout",this._onTimeout),this._robustWebSocket.on("message",this._onMessage),this._robustWebSocket.on("closing",this._onClosing),this._robustWebSocket.on("close",this._onClose),this._robustWebSocket.on("error",this._onError)}_removeWebSocketEvent(){this._robustWebSocket.off("connecting",this._onConnecting),this._robustWebSocket.off("open",this._onOpen),this._robustWebSocket.off("timeout",this._onTimeout),this._robustWebSocket.off("message",this._onMessage),this._robustWebSocket.off("closing",this._onClosing),this._robustWebSocket.off("close",this._onClose),this._robustWebSocket.off("error",this._onError)}_getAppConfig(e){const t=Object.assign({},B,e);if(!t.key)throw new Error("unavailable appKey");if(!t.secret)throw new Error("unavailable appKey");return t}}var W;!function(e){e.isReady="Are You OK?",e.ready="I`m OK!",e.ping="ping",e.pong="pong",e.alive="I`m alive!"}(W||(W={}));const V=[W.alive,W.isReady,W.ping,W.pong,W.ready];var G;!function(e){e.request="request",e.scheme="scheme",e.message="message",e.unknown="unknown"}(G||(G={}));const $=getApp({allowDefault:!0});var q={};({get exports(){return q},set exports(e){q=e}}).exports=function(){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n(Object(r),!0).forEach((function(t){s(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function a(){var e=(new Date).getTime(),t=new Date(e),r=t.getHours(),i=t.getMinutes(),s=t.getSeconds(),n=t.getMilliseconds();return r=r<10?"0".concat(r):r,i=i<10?"0".concat(i):i,s=s<10?"0".concat(s):s,"".concat(r,":").concat(i,":").concat(s,".").concat(n)}var c="TRTC-WX",u=0,l=1,h=2,p=3,d=new(function(){function e(){t(this,e),this.logLevel=0}return i(e,[{key:"setLogLevel",value:function(e){this.logLevel=e}},{key:"log",value:function(){var e;this.logLevel===u&&(e=console).log.apply(e,[c,a()].concat(Array.prototype.slice.call(arguments)))}},{key:"info",value:function(){var e;this.logLevel<=l&&(e=console).info.apply(e,[c,a()].concat(Array.prototype.slice.call(arguments)))}},{key:"warn",value:function(){var e;this.logLevel<=h&&(e=console).warn.apply(e,[c,a()].concat(Array.prototype.slice.call(arguments)))}},{key:"error",value:function(){var e;this.logLevel<=p&&(e=console).error.apply(e,[c,a()].concat(Array.prototype.slice.call(arguments)))}}]),e}()),v=function(e){var t=/[\u4e00-\u9fa5]/;return e.sdkAppID?void 0===e.roomID&&void 0===e.strRoomID?(d.error("未设置 roomID"),!1):!e.strRoomID&&(e.roomID<1||e.roomID>4294967296)?(d.error("roomID 超出取值范围 1 ~ 4294967295"),!1):e.strRoomID&&t.test(e.strRoomID)?(d.error("strRoomID 请勿使用中文字符"),!1):e.userID?e.userID&&t.test(e.userID)?(d.error("userID 请勿使用中文字符"),!1):!!e.userSig||(d.error("未设置 userSig"),!1):(d.error("未设置 userID"),!1):(d.error("未设置 sdkAppID"),!1)},f={LOCAL_JOIN:"LOCAL_JOIN",LOCAL_LEAVE:"LOCAL_LEAVE",KICKED_OUT:"KICKED_OUT",REMOTE_USER_JOIN:"REMOTE_USER_JOIN",REMOTE_USER_LEAVE:"REMOTE_USER_LEAVE",REMOTE_VIDEO_ADD:"REMOTE_VIDEO_ADD",REMOTE_VIDEO_REMOVE:"REMOTE_VIDEO_REMOVE",REMOTE_AUDIO_ADD:"REMOTE_AUDIO_ADD",REMOTE_AUDIO_REMOVE:"REMOTE_AUDIO_REMOVE",REMOTE_STATE_UPDATE:"REMOTE_STATE_UPDATE",LOCAL_NET_STATE_UPDATE:"LOCAL_NET_STATE_UPDATE",REMOTE_NET_STATE_UPDATE:"REMOTE_NET_STATE_UPDATE",LOCAL_AUDIO_VOLUME_UPDATE:"LOCAL_AUDIO_VOLUME_UPDATE",REMOTE_AUDIO_VOLUME_UPDATE:"REMOTE_AUDIO_VOLUME_UPDATE",VIDEO_FULLSCREEN_UPDATE:"VIDEO_FULLSCREEN_UPDATE",BGM_PLAY_START:"BGM_PLAY_START",BGM_PLAY_FAIL:"BGM_PLAY_FAIL",BGM_PLAY_PROGRESS:"BGM_PLAY_PROGRESS",BGM_PLAY_COMPLETE:"BGM_PLAY_COMPLETE",ERROR:"ERROR",IM_READY:"IM_READY",IM_MESSAGE_RECEIVED:"IM_MESSAGE_RECEIVED",IM_NOT_READY:"IM_NOT_READY",IM_KICKED_OUT:"IM_KICKED_OUT",IM_ERROR:"IM_ERROR"},m={url:"",mode:"RTC",autopush:!1,enableCamera:!1,enableMic:!1,enableAgc:!1,enableAns:!1,enableEarMonitor:!1,enableAutoFocus:!0,enableZoom:!1,minBitrate:600,maxBitrate:900,videoWidth:360,videoHeight:640,beautyLevel:0,whitenessLevel:0,videoOrientation:"vertical",videoAspect:"9:16",frontCamera:"front",enableRemoteMirror:!1,localMirror:"auto",enableBackgroundMute:!1,audioQuality:"high",audioVolumeType:"voicecall",audioReverbType:0,waitingImage:"",waitingImageHash:"",beautyStyle:"smooth",filter:"",netStatus:{}},b={src:"",mode:"RTC",autoplay:!0,muteAudio:!0,muteVideo:!0,orientation:"vertical",objectFit:"fillCrop",enableBackgroundMute:!1,minCache:1,maxCache:2,soundMode:"speaker",enableRecvMessage:!1,autoPauseIfNavigate:!0,autoPauseIfOpenNative:!0,isVisible:!0,_definitionType:"main",netStatus:{}};function g(){var e=new Date;return e.setTime((new Date).getTime()+0),e.toLocaleString()}(new Date).getTime();var _=function(e){var t=[];if(e&&e.TUIScene&&t.push(e.TUIScene),e&&"test"===e.env)return"default";if(wx&&wx.TUIScene&&t.push(wx.TUIScene),wx&&"function"==typeof getApp){var r=getApp().globalData;r&&r.TUIScene&&t.push(r.TUIScene)}return wx&&wx.getStorage({key:"TUIScene",success:function(e){t.push(e.data)}}),t[0]||"default"},y=new(function(){function e(){t(this,e),this.sdkAppId="",this.userId="",this.version="",this.common={}}return i(e,[{key:"setConfig",value:function(e){this.sdkAppId="".concat(e.sdkAppId),this.userId="".concat(e.userId),this.version="".concat(e.version),this.common.TUIScene=_(e)}},{key:"log",value:function(e){wx.request({url:"https://yun.tim.qq.com/v5/AVQualityReportSvc/C2S?sdkappid=1&cmdtype=jssdk_log",method:"POST",header:{"content-type":"application/json"},data:{timestamp:g(),sdkAppId:this.sdkAppId,userId:this.userId,version:this.version,log:JSON.stringify(o(o({},e),this.common))}})}}]),e}()),w="enterRoom",E="exitRoom",k="setPusherAttributes",S="setPlayerAttributes",O="init",I="error",A="connectServer",P="startPusher",T="openCamera",C="screenCap",L="pusherResolution",D="pusherCodeRate",x="collectionFirstFrame",M="encoderStart",R="enterRoomSuccess",j="exitRoomSuccess",U="kicked_out",B="renderFirstFrame",N="miniAppHang",H="closeSuspension",W="other",V="update",G="addUser",$="remove_user",q="update_user_video",K="update_user_audio",F="pusherStart",z="pusherStop",Y="pusherPause",J="pusherResume",Q=function(){function r(e,i){t(this,r),this.context=wx.createLivePusherContext(i),this.pusherAttributes={},Object.assign(this.pusherAttributes,m,e)}return i(r,[{key:"setPusherAttributes",value:function(e){return Object.assign(this.pusherAttributes,e),this.pusherAttributes}},{key:"start",value:function(e){d.log("[apiLog][pusherStart]"),y.log({name:F,options:e}),this.context.start(e)}},{key:"stop",value:function(e){d.log("[apiLog][pusherStop]"),y.log({name:z,options:e}),this.context.stop(e)}},{key:"pause",value:function(e){d.log("[apiLog] pusherPause()"),y.log({name:Y,options:e}),this.context.pause(e)}},{key:"resume",value:function(e){d.log("[apiLog][pusherResume]"),y.log({name:J,options:e}),this.context.resume(e)}},{key:"switchCamera",value:function(e){return d.log("[apiLog][switchCamera]"),this.pusherAttributes.frontCamera="front"===this.pusherAttributes.frontCamera?"back":"front",this.context.switchCamera(e),this.pusherAttributes}},{key:"sendMessage",value:function(e){d.log("[apiLog][sendMessage]",e.msg),this.context.sendMessage(e)}},{key:"snapshot",value:function(){var e=this;return d.log("[apiLog][pusherSnapshot]"),new Promise((function(t,r){e.context.snapshot({quality:"raw",complete:function(e){e.tempImagePath?(wx.saveImageToPhotosAlbum({filePath:e.tempImagePath,success:function(r){t(e)},fail:function(e){d.error("[error] pusher截图失败: ",e),r(new Error("截图失败"))}}),t(e)):(d.error("[error] snapShot 回调失败",e),r(new Error("截图失败")))}})}))}},{key:"toggleTorch",value:function(e){this.context.toggleTorch(e)}},{key:"startDumpAudio",value:function(e){this.context.startDumpAudio(e)}},{key:"stopDumpAudio",value:function(e){this.context.startDumpAudio(e)}},{key:"playBGM",value:function(e){d.log("[apiLog] playBGM() url: ",e.url),this.context.playBGM(e)}},{key:"pauseBGM",value:function(e){d.log("[apiLog] pauseBGM()"),this.context.pauseBGM(e)}},{key:"resumeBGM",value:function(e){d.log("[apiLog] resumeBGM()"),this.context.resumeBGM(e)}},{key:"stopBGM",value:function(e){d.log("[apiLog] stopBGM()"),this.context.stopBGM(e)}},{key:"setBGMVolume",value:function(t){d.log("[apiLog] setBGMVolume() volume:",t),t&&t.volume&&"object"===e(t.volume)&&t.volume.volume?this.context.setBGMVolume(t.volume):this.context.setBGMVolume(t)}},{key:"setMICVolume",value:function(t){d.log("[apiLog] setMICVolume() volume:",t),t&&t.volume&&"object"===e(t.volume)&&t.volume.volume?this.context.setMICVolume(t.volume):this.context.setMICVolume(t)}},{key:"startPreview",value:function(e){d.log("[apiLog] startPreview()"),this.context.startPreview(e)}},{key:"stopPreview",value:function(e){d.log("[apiLog] stopPreview()"),this.context.stopPreview(e)}},{key:"reset",value:function(){return this.pusherConfig={},this.context&&(this.stop({success:function(){}}),this.context=null),this.pusherAttributes}}]),r}(),Z=function e(r){t(this,e),Object.assign(this,{userID:"",streams:{}},r)},X=function(){function e(r,i){t(this,e),this.ctx=i,this.playerAttributes=this.getInitPlayerAttributes(r)}return i(e,[{key:"play",value:function(e){this.getPlayerContext().play(e)}},{key:"stop",value:function(e){this.getPlayerContext().stop(e)}},{key:"mute",value:function(e){this.getPlayerContext().mute(e)}},{key:"pause",value:function(e){this.getPlayerContext().pause(e)}},{key:"resume",value:function(e){this.getPlayerContext().resume(e)}},{key:"requestFullScreen",value:function(e){var t=this;return new Promise((function(r,i){t.getPlayerContext().requestFullScreen({direction:e.direction,success:function(e){r(e)},fail:function(e){i(e)}})}))}},{key:"requestExitFullScreen",value:function(){var e=this;return new Promise((function(t,r){e.getPlayerContext().exitFullScreen({success:function(e){t(e)},fail:function(e){r(e)}})}))}},{key:"snapshot",value:function(e){var t=this;return d.log("[playerSnapshot]",e),new Promise((function(e,r){t.getPlayerContext().snapshot({quality:"raw",complete:function(t){t.tempImagePath?(wx.saveImageToPhotosAlbum({filePath:t.tempImagePath,success:function(r){d.log("save photo is success",r),e(t)},fail:function(e){d.error("save photo is fail",e),r(e)}}),e(t)):(d.error("snapShot 回调失败",t),r(new Error("截图失败")))}})}))}},{key:"setPlayerAttributes",value:function(e){this.playerAttributes=Object.assign({},this.playerAttributes,e)}},{key:"getPlayerContext",value:function(){return this.playerContext||(this.playerContext=wx.createLivePlayerContext(this.playerAttributes.id,this.ctx)),this.playerContext}},{key:"reset",value:function(){this.playerContext&&(this.playerContext.stop(),this.playerContext=void 0),this.playerAttributes=this.getInitPlayerAttributes()}},{key:"getInitPlayerAttributes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},b,{userID:"",streamType:"",streamID:"",id:"",hasVideo:!1,hasAudio:!1,volume:0,playerContext:void 0},e)}}]),e}(),ee="UserController",te=function(){function e(r,i){t(this,e),this.ctx=i,this.userMap=new Map,this.userList=[],this.streamList=[],this.emitter=r}return i(e,[{key:"userEventHandler",value:function(e){var t=e.detail.code,r=e.detail.message,i={name:W,code:t,message:r,data:""};switch(t){case 0:d.log(r,t);break;case 1001:d.log("已经连接推流服务器",t),i.name=A;break;case 1002:d.log("已经与服务器握手完毕,开始推流",t),i.name=P;break;case 1003:d.log("打开摄像头成功",t),i.name=T;break;case 1004:d.log("录屏启动成功",t),i.name=C;break;case 1005:d.log("推流动态调整分辨率",t),i.name=L;break;case 1006:d.log("推流动态调整码率",t),i.name=D;break;case 1007:d.log("首帧画面采集完成",t),i.name=x;break;case 1008:d.log("编码器启动",t),i.name=M;break;case 1018:d.log("进房成功",t),i.name=R,i.data="event enterRoom success",this.emitter.emit(f.LOCAL_JOIN);break;case 1019:d.log("退出房间",t),r.indexOf("reason[0]")>-1?(i.name=j,i.data="event exitRoom success"):(i.name=U,i.data="event abnormal exitRoom",this.emitter.emit(f.KICKED_OUT));break;case 2003:d.log("渲染首帧视频",t),i.name=B;break;case-1301:d.error("打开摄像头失败: ",t),i.name=I,i.data="event start camera failed",this.emitter.emit(f.ERROR,{code:t,message:r});break;case-1302:i.name=I,i.data="event start microphone failed",d.error("打开麦克风失败: ",t),this.emitter.emit(f.ERROR,{code:t,message:r});break;case-1303:d.error("视频编码失败: ",t),i.name=I,i.data="event video encode failed",this.emitter.emit(f.ERROR,{code:t,message:r});break;case-1304:d.error("音频编码失败: ",t),i.name=I,i.data="event audio encode failed",this.emitter.emit(f.ERROR,{code:t,message:r});break;case-1307:d.error("推流连接断开: ",t),i.name=I,i.data="event pusher stream failed",this.emitter.emit(f.ERROR,{code:t,message:r});break;case-100018:d.error("进房失败: userSig 校验失败，请检查 userSig 是否填写正确",t,r),i.name=I,i.data="event userSig is error",this.emitter.emit(f.ERROR,{code:t,message:r});break;case 5e3:d.log("小程序被挂起: ",t),i.name=N,i.data="miniApp is hang";break;case 5001:d.log("小程序悬浮窗被关闭: ",t),i.name=H;break;case 1021:d.log("网络类型发生变化，需要重新进房",t);break;case 2007:d.log("本地视频播放loading: ",t);break;case 2004:d.log("本地视频播放开始: ",t);break;case 1031:case 1032:case 1033:case 1034:this._handleUserEvent(e)}y.log(i)}},{key:"_handleUserEvent",value:function(e){var t,r=e.detail.code,i=e.detail.message;if(!e.detail.message||"string"!=typeof i)return d.warn(ee,"userEventHandler 数据格式错误"),!1;try{t=JSON.parse(e.detail.message)}catch(e){return d.warn(ee,"userEventHandler 数据格式错误",e),!1}switch(this.emitter.emit(f.LOCAL_STATE_UPDATE,e),y.log({name:V,code:r,message:i,data:t}),r){case 1031:this.addUser(t);break;case 1032:this.removeUser(t);break;case 1033:this.updateUserVideo(t);break;case 1034:this.updateUserAudio(t)}}},{key:"addUser",value:function(e){var t=this;d.log("addUser",e);var r=e.userlist;Array.isArray(r)&&r.length>0&&r.forEach((function(e){var r=e.userid,i=t.getUser(r);i||(i=new Z({userID:r}),t.userList.push({userID:r})),t.userMap.set(r,i),t.emitter.emit(f.REMOTE_USER_JOIN,{userID:r,userList:t.userList,playerList:t.getPlayerList()}),y.log({name:G,userID:r,userList:t.userList,playerList:t.getPlayerList()})}))}},{key:"removeUser",value:function(e){var t=this,r=e.userlist;Array.isArray(r)&&r.length>0&&r.forEach((function(e){var r=e.userid,i=t.getUser(r);i&&i.streams&&(t._removeUserAndStream(r),i.streams.main&&i.streams.main.reset(),i.streams.aux&&i.streams.aux.reset(),t.emitter.emit(f.REMOTE_USER_LEAVE,{userID:r,userList:t.userList,playerList:t.getPlayerList()}),y.log({name:$,userID:r,userList:t.userList,playerList:t.getPlayerList()}),i=void 0,t.userMap.delete(r))}))}},{key:"updateUserVideo",value:function(e){var t=this;d.log(ee,"updateUserVideo",e);var r=e.userlist;Array.isArray(r)&&r.length>0&&r.forEach((function(e){var r=e.userid,i=e.streamtype,s="".concat(r,"_").concat(i),n=s,o=e.hasvideo,a=e.playurl,c=t.getUser(r);if(c){var u=c.streams[i];d.log(ee,"updateUserVideo start",c,i,u),u?(u.setPlayerAttributes({hasVideo:o}),o||u.playerAttributes.hasAudio||t._removeStream(u)):(u=new X({userID:r,streamID:s,hasVideo:o,src:a,streamType:i,id:n},t.ctx),c.streams[i]=u,t._addStream(u)),"aux"===i&&(o?(u.setPlayerAttributes({objectFit:"contain",muteAudio:!1}),t._addStream(u)):t._removeStream(u)),t.userList.find((function(e){if(e.userID===r)return e["has".concat(i.replace(/^\S/,(function(e){return e.toUpperCase()})),"Video")]=o,!0})),d.log(ee,"updateUserVideo end",c,i,u);var l=o?f.REMOTE_VIDEO_ADD:f.REMOTE_VIDEO_REMOVE;t.emitter.emit(l,{player:u.playerAttributes,userList:t.userList,playerList:t.getPlayerList()}),y.log({name:q,player:u.playerAttributes,userList:t.userList,playerList:t.getPlayerList()})}}))}},{key:"updateUserAudio",value:function(e){var t=this,r=e.userlist;Array.isArray(r)&&r.length>0&&r.forEach((function(e){var r=e.userid,i="main",s="".concat(r,"_").concat(i),n=s,o=e.hasaudio,a=e.playurl,c=t.getUser(r);if(c){var u=c.streams.main;u?(u.setPlayerAttributes({hasAudio:o}),o||u.playerAttributes.hasVideo||t._removeStream(u)):(u=new X({userID:r,streamID:s,hasAudio:o,src:a,streamType:i,id:n},t.ctx),c.streams.main=u,t._addStream(u)),t.userList.find((function(e){if(e.userID===r)return e["has".concat(i.replace(/^\S/,(function(e){return e.toUpperCase()})),"Audio")]=o,!0}));var l=o?f.REMOTE_AUDIO_ADD:f.REMOTE_AUDIO_REMOVE;t.emitter.emit(l,{player:u.playerAttributes,userList:t.userList,playerList:t.getPlayerList()}),y.log({name:K,player:u.playerAttributes,userList:t.userList,playerList:t.getPlayerList()})}}))}},{key:"getUser",value:function(e){return this.userMap.get(e)}},{key:"getStream",value:function(e){var t=e.userID,r=e.streamType,i=this.userMap.get(t);if(i)return i.streams[r]}},{key:"getUserList",value:function(){return this.userList}},{key:"getStreamList",value:function(){return this.streamList}},{key:"getPlayerList",value:function(){return this.getStreamList().map((function(e){return Object.assign({},e.playerAttributes)}))}},{key:"reset",value:function(){return this.streamList.forEach((function(e){e.reset()})),this.streamList=[],this.userList=[],this.userMap.clear(),{userList:this.userList,streamList:this.streamList}}},{key:"_removeUserAndStream",value:function(e){this.streamList=this.streamList.filter((function(t){return t.playerAttributes.userID!==e&&""!==t.playerAttributes.userID})),this.userList=this.userList.filter((function(t){return t.userID!==e}))}},{key:"_addStream",value:function(e){-1===this.streamList.findIndex((function(t){return t.playerAttributes.userID===e.playerAttributes.userID&&t.playerAttributes.streamType===e.playerAttributes.streamType}))&&this.streamList.push(e)}},{key:"_removeStream",value:function(e){this.streamList=this.streamList.filter((function(t){return t.playerAttributes.userID!==e.playerAttributes.userID||t.playerAttributes.streamType!==e.playerAttributes.streamType})),this.getUser(e.playerAttributes.userID).streams[e.playerAttributes.streamType]=void 0}}]),e}(),re=function(){function e(){t(this,e)}return i(e,[{key:"on",value:function(e,t,r){"function"==typeof t&&(this._stores=this._stores||{},(this._stores[e]=this._stores[e]||[]).push({cb:t,ctx:r}))}},{key:"emit",value:function(e){this._stores=this._stores||{};var t,r=this._stores[e];if(r){r=r.slice(0),(t=[].slice.call(arguments,1))[0]={eventCode:e,data:t[0]};for(var i=0,s=r.length;i<s;i++)r[i].cb.apply(r[i].ctx,t)}}},{key:"off",value:function(e,t){if(this._stores=this._stores||{},arguments.length){var r=this._stores[e];if(r)if(1!==arguments.length){for(var i=0,s=r.length;i<s;i++)if(r[i].cb===t){r.splice(i,1);break}}else delete this._stores[e]}else this._stores={}}}]),e}();return function(){function e(r,i){var s=this;t(this,e),this.env="prod",this.ctx=r,this.eventEmitter=new re,this.pusherInstance=null,this.userController=new te(this.eventEmitter,this.ctx),this.EVENT=f,this.TUIScene=null==i?void 0:i.TUIScene,"test"!==(null==i?void 0:i.env)?wx.getSystemInfo({success:function(e){return s.systemInfo=e}}):(this.env="test",y.log=function(){},d.log=function(){},d.warn=function(){})}return i(e,[{key:"initLog",value:function(e){y.setConfig({sdkAppId:e.sdkAppID,userId:e.userID,version:"wechat-mini",TUIScene:this.TUIScene,env:this.env})}},{key:"setLogLevel",value:function(e){d.setLogLevel(e)}},{key:"on",value:function(e,t,r){d.log("[on] 事件订阅: ".concat(e)),this.eventEmitter.on(e,t,r)}},{key:"off",value:function(e,t){d.log("[off] 取消订阅: ".concat(e)),this.eventEmitter.off(e,t)}},{key:"createPusher",value:function(e){return this.pusherInstance=new Q(e,this.ctx),d.log("pusherInstance",this.pusherInstance),this.pusherInstance}},{key:"getPusherInstance",value:function(){return this.pusherInstance}},{key:"enterRoom",value:function(e){d.log("[apiLog] [enterRoom]",e);var t=function(e){if(!v(e))return null;e.scene=e.scene&&"rtc"!==e.scene?e.scene:"videocall",e.enableBlackStream=e.enableBlackStream||"",e.encsmall=e.encsmall||0,e.cloudenv=e.cloudenv||"PRO",e.streamID=e.streamID||"",e.userDefineRecordID=e.userDefineRecordID||"",e.privateMapKey=e.privateMapKey||"",e.pureAudioMode=e.pureAudioMode||"",e.recvMode=e.recvMode||1;var t="";return t=e.strRoomID?"&strroomid=".concat(e.strRoomID):"&roomid=".concat(e.roomID),"room://cloud.tencent.com/rtc?sdkappid=".concat(e.sdkAppID).concat(t,"&userid=").concat(e.userID,"&usersig=").concat(e.userSig,"&appscene=").concat(e.scene,"&encsmall=").concat(e.encsmall,"&cloudenv=").concat(e.cloudenv,"&enableBlackStream=").concat(e.enableBlackStream,"&streamid=").concat(e.streamID,"&userdefinerecordid=").concat(e.userDefineRecordID,"&privatemapkey=").concat(e.privateMapKey,"&pureaudiomode=").concat(e.pureAudioMode,"&recvmode=").concat(e.recvMode,"&component=").concat(function(){var e="";try{e=wx&&wx.TUIScene?wx.TUIScene:wx&&wx.getStorageSync&&wx.getStorageSync("TUIScene")?wx.getStorageSync("TUIScene"):getApp&&getApp()&&getApp().globalData&&getApp().globalData.TUIScene?getApp().globalData.TUIScene:""}catch(t){e=""}switch(e){case"sampleDemo":return 2;case"TUICalling":return 3;case"TUIRoom":return 5;case"TUIVoiceRoom":return 6;case"TIMCalling":return 10;case"TUICallKit":return 14;case"TIMCallKit":return 15;default:return 1}}())}(e);return this.initLog(o(o({},e),{},{env:this.env})),y.log({name:O}),t||(this.eventEmitter.emit(f.ERROR,{message:"进房参数错误"}),y.log({name:I,message:"进房参数错误",data:e})),this.pusherInstance.setPusherAttributes(o(o({},e),{},{url:t})),d.warn("[statusLog] [enterRoom]",this.pusherInstance.pusherAttributes),y.log({name:w,pusherConfig:this.pusherInstance.pusherAttributes}),this.getPusherAttributes()}},{key:"exitRoom",value:function(){this.userController.reset();var e=Object.assign({pusher:this.pusherInstance.reset()},{playerList:this.userController.getPlayerList()});return this.eventEmitter.emit(f.LOCAL_LEAVE),y.log({name:E,data:e}),e}},{key:"getPlayerList",value:function(){var e=this.userController.getPlayerList();return d.log("[apiLog][getStreamList]",e),e}},{key:"setPusherAttributes",value:function(e){return d.log("[apiLog] [setPusherAttributes], ",e),this.pusherInstance.setPusherAttributes(e),d.warn("[statusLog] [setPusherAttributes]",this.pusherInstance.pusherAttributes),y.log({name:k,options:e,pusherConfig:this.pusherInstance.pusherAttributes}),this.pusherInstance.pusherAttributes}},{key:"getPusherAttributes",value:function(){return d.log("[apiLog] [getPusherConfig]"),this.pusherInstance.pusherAttributes}},{key:"setPlayerAttributes",value:function(e,t){d.log("[apiLog] [setPlayerAttributes] id",e,"options: ",t);var r=this._transformStreamID(e),i=r.userID,s=r.streamType,n=this.userController.getStream({userID:i,streamType:s});return n?(n.setPlayerAttributes(t),y.log({name:S,id:e,options:t,playerList:this.getPlayerList()}),this.getPlayerList()):this.getPlayerList()}},{key:"getPlayerInstance",value:function(e){var t=this._transformStreamID(e),r=t.userID,i=t.streamType;return d.log("[api][getPlayerInstance] id:",e),this.userController.getStream({userID:r,streamType:i})}},{key:"switchStreamType",value:function(e){d.log("[apiLog] [switchStreamType] id: ",e);var t=this._transformStreamID(e),r=t.userID,i=t.streamType,s=this.userController.getStream({userID:r,streamType:i});return"main"===s._definitionType?(s.src=s.src.replace("main","small"),s._definitionType="small"):(s.src=s.src.replace("small","main"),s._definitionType="main"),this.getPlayerList()}},{key:"pusherEventHandler",value:function(e){this.userController.userEventHandler(e)}},{key:"pusherNetStatusHandler",value:function(e){var t=e.detail.info;this.pusherInstance.setPusherAttributes(t),this.eventEmitter.emit(f.LOCAL_NET_STATE_UPDATE,{pusher:this.pusherInstance.pusherAttributes})}},{key:"pusherErrorHandler",value:function(e){try{var t=e.detail.errCode,r=e.detail.errMsg;this.eventEmitter.emit(f.ERROR,{code:t,message:r}),y.log({name:I,code:t,message:r})}catch(t){d.error("pusher error data parser exception",e,t)}}},{key:"pusherBGMStartHandler",value:function(e){this.eventEmitter.emit(f.BGM_PLAY_START)}},{key:"pusherBGMProgressHandler",value:function(e){var t,r,i,s;this.eventEmitter.emit(f.BGM_PLAY_PROGRESS,{progress:null===(t=e.data)||void 0===t||null===(r=t.detail)||void 0===r?void 0:r.progress,duration:null===(i=e.data)||void 0===i||null===(s=i.detail)||void 0===s?void 0:s.duration})}},{key:"pusherBGMCompleteHandler",value:function(e){this.eventEmitter.emit(f.BGM_PLAY_COMPLETE)}},{key:"pusherAudioVolumeNotify",value:function(e){this.pusherInstance.pusherAttributes.volume=e.detail.volume,this.eventEmitter.emit(f.LOCAL_AUDIO_VOLUME_UPDATE,{pusher:this.pusherInstance.pusherAttributes})}},{key:"playerEventHandler",value:function(e){d.log("[statusLog][playerStateChange]",e),this.eventEmitter.emit(f.REMOTE_STATE_UPDATE,e)}},{key:"playerFullscreenChange",value:function(e){this.eventEmitter.emit(f.VIDEO_FULLSCREEN_UPDATE)}},{key:"playerNetStatus",value:function(e){var t=this._transformStreamID(e.currentTarget.dataset.streamid),r=t.userID,i=t.streamType,s=this.userController.getStream({userID:r,streamType:i});!s||s.videoWidth===e.detail.info.videoWidth&&s.videoHeight===e.detail.info.videoHeight||(s.setPlayerAttributes({netStatus:e.detail.info}),this.eventEmitter.emit(f.REMOTE_NET_STATE_UPDATE,{playerList:this.userController.getPlayerList()}))}},{key:"playerAudioVolumeNotify",value:function(e){var t=this._transformStreamID(e.currentTarget.dataset.streamid),r=t.userID,i=t.streamType,s=this.userController.getStream({userID:r,streamType:i}),n=e.detail.volume;s.setPlayerAttributes({volume:n}),this.eventEmitter.emit(f.REMOTE_AUDIO_VOLUME_UPDATE,{playerList:this.userController.getPlayerList()})}},{key:"_transformStreamID",value:function(e){var t=e.lastIndexOf("_");return{userID:e.slice(0,t),streamType:e.slice(t+1)}}}]),e}()}();const K={enableMic:!0,enableCamera:!1,enableAgc:!0,enableAns:!0,enableRemoteMirror:!1,enableZoom:!1};class F extends f{constructor(i){super(),Object.defineProperty(this,"_props",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_jsBridge",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_component",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_webviewState",{enumerable:!0,configurable:!0,writable:!0,value:{active:!1,orientation:"Portrait",minimized:0}}),Object.defineProperty(this,"init",{enumerable:!0,configurable:!0,writable:!0,value:t=>e(this,void 0,void 0,(function*(){var e,i,s,n;this._props="string"==typeof t?(e=>{const t=Array.isArray(e)?e:[e],r={};return t.forEach((e=>{r[e]=$.__RsVrWebviewPropsMap__.get(e)})),Array.isArray(e)?r:r[e]})(t):t;try{this._checkProps(this._props),(null===(e=this._props.options.rtc)||void 0===e?void 0:e.trtc)||(this._props.options.rtc=Object.assign(this._props.options.rtc||{},{trtc:new q(this._component)})),yield this._jsBridge.init(this._props);const t=this._jsBridge.wssQuery4Webview||"";let o=r(this._props.url,t);try{const e=yield null===(i=this._props.options.app)||void 0===i?void 0:i.key;e&&(o=r(o,`open_app_id=${e}`))}catch(e){}try{const e=yield null===(n=null===(s=this._props.behaviors)||void 0===s?void 0:s.getToken)||void 0===n?void 0:n.call(s);e&&(o=r(o,`wx_token=${e}`))}catch(e){}try{const e=yield wx.getStorageSync("__Realsee_Telemetry_Session_Storage__");"string"==typeof e&&""!==e&&(o=r(o,`rstpsid=${e}`))}catch(e){}yield this._setDataAsync({url:o})}catch(e){this._onError(e)}}))}),Object.defineProperty(this,"dispose",{enumerable:!0,configurable:!0,writable:!0,value:()=>{try{this._rtcQuit()}catch(e){}this._jsBridge.dispose(),this._disposers.forEach((e=>e())),this._disposers=[]}}),Object.defineProperty(this,"_disposers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"_addInnerEventLister",{enumerable:!0,configurable:!0,writable:!0,value:()=>{const e=()=>{this._webviewState.active=!0,this.emit("webviewStateChange",this._webviewState)},t=()=>{this._webviewState.active=!1,this.emit("webviewStateChange",this._webviewState)};wx.onAppShow(e),wx.onAppHide(t),this._disposers.push((()=>wx.offAppShow(e)),(()=>wx.offAppHide(t)))}}),Object.defineProperty(this,"_checkProps",{enumerable:!0,configurable:!0,writable:!0,value:e=>{if(!e)throw new Error("unavailable props, please check!");let{url:t,options:r}=e;if(!t)throw new Error("unavailable url, please check!");if(!r)throw new Error("unavailable options, please check!");const{app:i}=r;if(!(null==i?void 0:i.key)||!(null==i?void 0:i.secret))throw new Error("unavailable app options, please check!")}}),Object.defineProperty(this,"_setData",{enumerable:!0,configurable:!0,writable:!0,value:(e,t)=>{this._component.setData(e,t)}}),Object.defineProperty(this,"_setDataAsync",{enumerable:!0,configurable:!0,writable:!0,value:t=>e(this,void 0,void 0,(function*(){return new Promise((e=>this._setData(t,(()=>e()))))}))}),Object.defineProperty(this,"_onError",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t,r;if("function"!=typeof(null===(t=this._props.behaviors)||void 0===t?void 0:t.onError))throw e;null===(r=this._props.behaviors)||void 0===r||r.onError(e)}}),Object.defineProperty(this,"_onMessage",{enumerable:!0,configurable:!0,writable:!0,value:e=>{console.log(e)}}),Object.defineProperty(this,"_onReady",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),Object.defineProperty(this,"_onClose",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),Object.defineProperty(this,"_onRequest",{enumerable:!0,configurable:!0,writable:!0,value:(t,r)=>e(this,void 0,void 0,(function*(){const{behaviors:e={}}=this._props;return"function"==typeof e[t]?yield e[t](r):wx.canIUse(t)?new Promise(((e,i)=>wx[t](Object.assign(Object.assign({},r),{success:e,fail:e=>i(e.errMsg)})))):Promise.reject(`behavior=${t} not implemented`)}))}),Object.defineProperty(this,"_innerSchemes",{enumerable:!0,configurable:!0,writable:!0,value:{"common/staticData":t=>e(this,void 0,void 0,(function*(){return yield this._innerSchemeCall(t,this._getStaticData)})),"common/loadProgress":({callback:e})=>e(!0),"common/closeLoading":({callback:e})=>e(!0),"common/minimize":({callback:e})=>e(new Error("小程序不支持该方法")),"common/setOrientation":({callback:e})=>e(new Error("小程序不支持该方法")),"common/keepScreenLight":({callback:e,params:t})=>wx.setKeepScreenOn({keepScreenOn:1===Number(t.enable),success:({errMsg:t})=>e(t),fail:({errMsg:t})=>e(new Error(t))}),"common/closeWebView":t=>e(this,void 0,void 0,(function*(){var e;return yield this._innerSchemeCall(t,null===(e=this._props.behaviors)||void 0===e?void 0:e._onExitVr)})),"common/saveImage2Album":({callback:e,params:t})=>wx.saveImageToPhotosAlbum({filePath:t.base64,success:({errMsg:t})=>e(t),fail:({errMsg:t})=>e(new Error(t))}),"common/preload":({callback:e,params:t})=>{const r=JSON.parse(t.urls).map((e=>new Promise((t=>wx.request({url:e,success:({errMsg:e})=>t(e),fail:({errMsg:e})=>t(e)})))));Promise.all(r).then((t=>e(t)))},"common/shock":({callback:e})=>wx.vibrateLong({success:({errMsg:t})=>e(t),fail:({errMsg:t})=>e(new Error(t))}),"common/getBangsHeight":({callback:e})=>e(0),"common/getDeviceInfo":t=>e(this,void 0,void 0,(function*(){return yield this._innerSchemeCall(t,this._getStaticData)})),"common/getUserInfo":t=>e(this,void 0,void 0,(function*(){var e,r;return yield this._innerSchemeCall(t,null===(r=null===(e=this._props)||void 0===e?void 0:e.behaviors)||void 0===r?void 0:r.getUserInfo)})),"common/login":t=>e(this,void 0,void 0,(function*(){var e,r;return yield this._innerSchemeCall(t,null===(r=null===(e=this._props)||void 0===e?void 0:e.behaviors)||void 0===r?void 0:r.requestLogin)})),"common/getWebViewState":({callback:e})=>e(this._webviewState),"common/detectMicro":t=>e(this,void 0,void 0,(function*(){return yield this._innerSchemeCall(t,this._rtcDetectMicro)})),"common/webViewState":({callback:e,type:t})=>{if("callAndBackfeed"===t)e(this._webviewState);else{const t=t=>e(t);this.on("webviewStateChange",t),this._disposers.push((()=>this.off("webviewStateChange",t)))}},"common/webViewError":({callback:e})=>{const t=t=>e(t.message);this.on("error",t),this._disposers.push((()=>this.off("error",t)))},"common/actionShare":t=>e(this,void 0,void 0,(function*(){var e;return yield this._innerSchemeCall(t,null===(e=this._props.behaviors)||void 0===e?void 0:e.actionShare)})),"live/join":t=>e(this,void 0,void 0,(function*(){return yield this._innerSchemeCall(t,this._rtcJoin)})),"live/toggleMicro":t=>e(this,void 0,void 0,(function*(){return yield this._innerSchemeCall(t,this._rtcToggleMicro)})),"live/quit":t=>e(this,void 0,void 0,(function*(){return yield this._innerSchemeCall(t,this._rtcQuit)})),"live/weakNetwork":({callback:e})=>{const t=t=>e(t);this.on("weakNetwork",t),this._disposers.push((()=>this.off("weakNetwork",t)))},"live/userVolumes":({callback:e})=>{const t=t=>e(t);this.on("userVolumes",t),this._disposers.push((()=>this.off("userVolumes",t)))}}}),Object.defineProperty(this,"_onScheme",{enumerable:!0,configurable:!0,writable:!0,value:({actionUrl:e,type:r="callAndBackfeed",callback:i})=>{var s,n;const o=(null===(n=null===(s=this._props.options)||void 0===s?void 0:s.info)||void 0===n?void 0:n.scheme)||"",a=e.replace(o+"://",""),[c,u=""]=a.split("?"),l=t(u),{schemes:h={}}=this._props;return"function"==typeof h[c]?h[c](i,r,l):"function"==typeof this._innerSchemes[c]?this._innerSchemes[c].call(this,{callback:i,type:r,params:l}):i(new Error(`scheme=(${c}) not implemented`))}}),Object.defineProperty(this,"onWebViewError",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t,r;null===(r=null===(t=this._props.behaviors)||void 0===t?void 0:t.onWebViewError)||void 0===r||r.call(t,e),this.emit("error",e)}}),Object.defineProperty(this,"_getStaticData",{enumerable:!0,configurable:!0,writable:!0,value:()=>e(this,void 0,void 0,(function*(){const e={};let t=this._props.options.info||{};try{const t=yield wx.getSystemInfo();e.sysModel=t.model,e.sysVersion=t.system}catch(e){this._onError(e)}try{const{networkType:t}=yield wx.getNetworkType();e.network=t}catch(e){this._onError(e)}return Object.assign(Object.assign({},t),e)}))}),Object.defineProperty(this,"_innerSchemeCall",{enumerable:!0,configurable:!0,writable:!0,value:({callback:t,type:r,params:i},s)=>e(this,void 0,void 0,(function*(){if("callAndBackfeed"===r)try{const e=yield null==s?void 0:s(i);t(e)}catch(e){t(e)}else t(new Error(`unavailable scheme type=(${r})`))}))}),Object.defineProperty(this,"_rtcDetectMicro",{enumerable:!0,configurable:!0,writable:!0,value:()=>e(this,void 0,void 0,(function*(){let e=!1;return!!(yield wx.getSetting()).authSetting["scope.record"]||(e=yield new Promise((e=>wx.authorize({scope:"scope.record",success:()=>e(!0),fail:()=>e(!1)}))),e||(e=yield new Promise((e=>wx.showModal({content:"您尚未授权麦克风",confirmText:"去设置",success:t=>{t.cancel&&e(!1),t.confirm&&wx.openSetting({success:t=>e(t.authSetting["scope.record"]||!1),fail:()=>e(!1)})},fail:()=>e(!1)}))),e))}))}),Object.defineProperty(this,"_rtcJoin",{enumerable:!0,configurable:!0,writable:!0,value:t=>e(this,void 0,void 0,(function*(){return new Promise(((r,i)=>e(this,void 0,void 0,(function*(){try{t.sdkAppID&&t.userID&&t.userSig&&t.roomID?yield this._jsBridge.rtc.initializeV2(t,K):t.config?yield this._jsBridge.rtc.oldInitialize(Object.assign(Object.assign({},t),{rtcConfig:K})):t.roomID&&t.userID&&(yield this._jsBridge.rtc.initialize(Object.assign(Object.assign({},t),{rtcConfig:K})));const e=yield this._jsBridge.rtc.enterRoom();yield this._setDataAsync({liveMode:!0,pusher:e}),this._jsBridge.rtc.start(),r(!0)}catch(e){this._onError(e),i(e)}}))))}))}),Object.defineProperty(this,"_rtcQuit",{enumerable:!0,configurable:!0,writable:!0,value:()=>e(this,void 0,void 0,(function*(){return new Promise(((t,r)=>e(this,void 0,void 0,(function*(){try{yield this._jsBridge.rtc.stop();const{pusher:e={},playerList:r=[]}=yield this._jsBridge.rtc.exitRoom();yield this._setDataAsync({liveMode:!1,pusher:e,playerList:r}),t(!0)}catch(e){this._onError(e),r(e)}}))))}))}),Object.defineProperty(this,"_rtcToggleMicro",{enumerable:!0,configurable:!0,writable:!0,value:t=>e(this,void 0,void 0,(function*(){return new Promise(((r,i)=>e(this,void 0,void 0,(function*(){const e=1===Number(t.flag)||!0===t.flag;try{const t=yield this._jsBridge.rtc.toggleMicrophone(e);yield this._setDataAsync({pusher:t}),r(!0)}catch(e){this._onError(e),i(e)}}))))}))}),this._component=i,this._jsBridge=new H({onReady:this._onReady,onClose:this._onClose,onMessage:this._onMessage,onError:this._onError,onRequest:this._onRequest,onScheme:this._onScheme}),this._addInnerEventLister()}get data(){return this._component.data}}Component({properties:{props:String},lifetimes:{created(){this.controller=new F(this)},attached(){this.controller.init(this.data.props)},detached(){this.controller.dispose()}},methods:{_handleWebViewError(e){this.controller.onWebViewError(e)},_handleWebViewLoad(e){console.info(`realsee vr-webview loaded url=(${e.detail.src})`)}}});
